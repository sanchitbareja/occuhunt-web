{% extends "recruiter/recruiter_base.html" %}
{% load static from staticfiles %}
{% load i18n %}
{% load url from future %}

{% block extra_style %}
<!-- Add css here -->
<link href="{% static 'occuhunt/css/recruiter_hire.css' %}" rel="stylesheet">
<script src="{% static 'occuhunt/js/custom-form-elements.js' %}"></script>
<script src="{% static 'underscore/underscore-min.js' %}"></script>
<style type="text/css">
  body {
    background-color: white;
    -webkit-font-smoothing: antialiased;
    font-smoothing: antialiased;
    font-smooth: always;
  }
  .list-group-item {
    border-radius: 0px;
  }

  #application_email {
    font-style: normal;
  }

  #application_status {
    font-style: normal;
  }

</style>

{% endblock %}

{% block extra_script %}
<!-- Add javascript here -->
<script type="text/javascript">

var applicants = [];

function get_events() {
  $.ajax({
    url: '/api/v1/fairs/',
    data: { },
    success: function(data, textStatus, jqXHR) {
        console.log(data);
        console.log(textStatus);
        console.log(jqXHR);
        for (var i = 0; i < data['objects'].length; i++) {
          $("#filter_event").append('<option value="'+data['objects'][i]['id']+'">'+data['objects'][i]['name']+'</option>');
        };
        get_candidates();
      },
    dataType: 'json',
  });
}

function set_fair_id(){
  $("#fair_id_input").val($("#filter_event").val());
}

function get_candidates() {
  applicants = [];
  clear_candidates();
  fair_id = $("#filter_event").val();
  degree_id = $("#degree_type").val();
  major_id = $("#major_type").val();
  grad_year = $("#grad_year").val();
  set_fair_id();
  // <option value="1">Applicants that are awaiting response</option>
  // <option value="2">Applicants I've talked to</option>
  // <option value="3">Applicants I've rejected</option>
  // <option value="4">Applicants to interview</option>
  // <option value="5">All event attendees</option>
  data_to_send = {};
  url = '/api/v1/applications/'
  if($("#filter_applicants").val() == "1"){
    company_id = $("#recruiter_id").val();
    url = '/api/v1/applications/?fair_id='+fair_id+'&company_id='+company_id+'&status__in=1&status__in=2';
  } else if ($("#filter_applicants").val() == "2") {
    company_id = $("#recruiter_id").val();
    url = '/api/v1/applications/?fair_id='+fair_id+'&company_id='+company_id+'&status__in=2';
  } else if ($("#filter_applicants").val() == "3") {
    company_id = $("#recruiter_id").val();
    url = '/api/v1/applications/?fair_id='+fair_id+'&company_id='+company_id+'&status__in=3';
  } else if ($("#filter_applicants").val() == "4") {
    company_id = $("#recruiter_id").val();
    url = '/api/v1/applications/?fair_id='+fair_id+'&company_id='+company_id+'&status__in=4';
  } else {
    url = '/api/v1/applications/?fair_id='+fair_id+'&unique_students=true';
    data_to_send = {'fair_id':fair_id, 'unique_students':true};
  }
  if(degree_id){
    url = url+'&degree_type='+degree_id;
  }
  if(major_id){
    url = url+'&major='+major_id;
  }
  if(grad_year){
    url = url+'&grad_year='+grad_year;
  }
  $.ajax({
    url: url,
    data: {},
    success: function(data, textStatus, jqXHR) {
        console.log(data);
        console.log(textStatus);
        console.log(jqXHR);
        search_applicants();
        if(data['response']['applications'].length > 0) {
          applicants = data['response']['applications'];
          for (var i = 0; i < data['response']['applications'].length; i++) {
            positions_list = split_commas(data['response']['applications'][i]['position']);
            positions = '';
            for (var j = 0; j < positions_list.length; j++){
              positions = positions.concat(' <span class="label label-success">'+positions_list[j]+'</span>');
            }
            $("#candidate_list").append('<a id="applicant_list_id_'+data['response']['applications'][i]['id']+'" onclick="get_candidate('+data['response']['applications'][i]['id']+')" class="list-group-item">'+data['response']['applications'][i]['user']['first_name']+' '+data['response']['applications'][i]['user']['last_name']+' '+positions+'</a>');
          };
          // auto-select the first candidate
          $("#applicant_list_id_"+data['response']['applications'][0]['id']).first().click();
        } else {
          $("#candidate_list").append('<a class="list-group-item">Sorry, no candidates :( Please choose another category</a>')
        }
      },
    dataType: 'json',
  });
}

function clear_candidates(){
  $("#candidate_list").empty();
}

function split_commas(str){
  return str.split(',');
}

function get_candidate(application_id) {
  // if candidate did apply to the company, then it must in fact 
  console.log(application_id);
  $.ajax({
    url: '/api/v1/applications/'+application_id+'/',
    data: { },
    success: function(data, textStatus, jqXHR) {
        console.log(data);
        console.log(textStatus);
        console.log(jqXHR);
        $("#application_info").show();
        // need to check if everything exist
        $("#application_first_name").text(data['user']['first_name']);
        $("#application_last_name").text(data['user']['last_name']);
        $("#application_email").text(data['user']['email']);
        $("#application_note").val(data['note']);
        $("#application_resume_img").attr({'src': data['user']['resume']});
        if($("#filter_applicants").val() == "1" || $("#filter_applicants").val() == "2"){
          // configure accept and reject buttons
          $("#accept_applicant_btn").attr({'onclick':'accept_candidate('+application_id+');'});
          $("#reject_applicant_btn").attr({'onclick':'reject_candidate('+application_id+');'});
          $("#reject_applicant_btn").show();
          $("#accept_applicant_btn").show();
          // configure notes
          $("#application_note_btn").attr({'onclick':'save_note('+application_id+');'});
          $("#note_div").show();
          // configure download pdf
          $("#download_pdf_btn").show();
          $("#download_pdf_btn").attr({'onclick':'download_pdf('+application_id+');'});
          // application status
          if($("#filter_applicants").val() == "1") {
            $("#application_status").text("Awaiting response");
          }
          if($("#filter_applicants").val() == "2") {
            $("#application_status").text("Met at fair - Awaiting response");
          }
        } else if ($("#filter_applicants").val() == "3" || $("#filter_applicants").val() == "4") {
          // configure accept and reject buttons
          $("#reject_applicant_btn").hide();
          $("#accept_applicant_btn").hide();
          // configure application notes
          $("#application_note_btn").attr({'onclick':'save_note('+application_id+');'});
          $("#note_div").show();
          // configure download pdf
          $("#download_pdf_btn").show();
          $("#download_pdf_btn").attr({'onclick':'download_pdf('+application_id+');'});
          // application status
          if($("#filter_applicants").val() == "3") {
            $("#application_status").text("Rejected");
          }
          if($("#filter_applicants").val() == "4") {
            $("#application_status").text("To invite for interview");
          }
        } else {
          // hide all other buttons
          $("#accept_applicant_btn").hide();
          $("#reject_applicant_btn").hide();
          $("#note_div").hide();
          $("#download_pdf_btn").hide();
          // application status config
          $("#application_status").text("Fair Attendee");
        }
      },
    dataType: 'json',
  });
}


function accept_candidate(application_id){
  $.ajax({
    url: '/api/v1/applications/'+String(application_id)+'/',
    type: 'PUT',
    data: JSON.stringify({
      'status': 4,
    }),
    dataType: 'json',
    contentType: 'application/json',
    success: function(data, textStatus, jsXHR){
      console.log(data);
      // remove person from list dom - never need to show again
      $("#applicant_list_id_"+String(application_id)).next().click();
      $("#applicant_list_id_"+String(application_id)).remove();

    }
  });
}

function reject_candidate(application_id){
  $.ajax({
    url: '/api/v1/applications/'+String(application_id)+'/',
    type: 'PUT',
    data: JSON.stringify({
      'status': 3,
    }),
    dataType: 'json',
    contentType: 'application/json',
    success: function(data, textStatus, jsXHR){
      console.log(data);
      // remove person from list dom and send it to 
      $("#applicant_list_id_"+String(application_id)).next().click();
      $("#applicant_list_id_"+String(application_id)).remove();
    }
  });
}

function save_note(application_id) {
  if($("#application_note").val()){
    $.ajax({
      url: '/api/v1/applications/'+String(application_id)+'/',
      type: 'PUT',
      data: JSON.stringify({
        'note': $("#application_note").val(),
      }),
      dataType: 'json',
      contentType: 'application/json',
      success: function(data, textStatus, jsXHR){
        console.log(data);
        // disable saving note
        disable_save_note();
        // alert("changes saved!");
      }
    });
  } else {
    alert("your note is empty!");
  }
}

function download_pdf(application_id) {
  // /recruiter/candidate/download_pdf/
  $.ajax({
    type: "POST",
    url: "/recruiter/candidate/download_pdf/",
    data: { application_id: application_id, csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() }
  }).done(function( returnData ) {
    if(returnData['success']){
      // extract resume url
      console.log(returnData);
      // being download process
      window.open(returnData['resume_pdf'],'_blank');
    } else {
      // ask them to give feedback or try again in a while.
    }
  });
}

function enable_save_note(){
  $("#application_note_btn").text("Save Note");
  $("#application_note_btn").attr({"disabled":false});
}

function disable_save_note(){
  $("#application_note_btn").text("Saved!");
  $("#application_note_btn").attr({"disabled":true});
}

function search_applicants(){
  $("#search_applicants").keyup(function(){
    query = $("#search_applicants").val();
    // get applicants by first_name, last_name and email
    applicants_sh = _.map(applicants,function(applicant){ 
      app_id = String(applicant['id']);
      applicant_majors = applicant["user"]["majors"].join(" ");
      search_text = applicant['user']["first_name"]+" "+applicant["user"]["last_name"]+" "+applicant["user"]["email"]+" "+applicant["user"]["graduation_year"]+" "+applicant["user"]["degree"]+" "+applicant_majors;
      dict = {};
      dict["app_id"] = app_id;
      dict["search_text"] = search_text;
      dict["first_name"] = applicant['user']["first_name"];
      dict["last_name"] = applicant['user']["last_name"];
      return dict;
    });
    // search in all fields
    matched_applicants = _.filter(applicants_sh, function(applicant){ 
      return (applicant["search_text"].toLowerCase().indexOf(query.toLowerCase()) > -1); 
    });
    console.log(matched_applicants);
    // clear candidates adn display just the list
    clear_candidates();
    // if list is empty, just get candidates again
    if(matched_applicants.length > 0) {
      for (var i = 0; i < matched_applicants.length; i++) {
        $("#candidate_list").append('<a id="applicant_list_id_'+matched_applicants[i]['app_id']+'" onclick="get_candidate('+matched_applicants[i]['app_id']+')" class="list-group-item">'+matched_applicants[i]['first_name']+' '+matched_applicants[i]['last_name']+'</a>');
      };
    } else {
      $("#candidate_list").append('<a class="list-group-item">Sorry, no candidates :( Please choose another category</a>')
    }
  });
}

$(document).ready(function() {
  get_events();
  // clear_candidates();
  // get_candidates();

  // on change of any of the filters
  $("#filter_school").on("change",get_candidates);
  $("#filter_event").on("change",get_candidates);
  $("#filter_applicants").on("change",get_candidates);
  $("#degree_type").on("change",get_candidates);
  $("#major_type").on("change",get_candidates);
  $("#grad_year").on("change",get_candidates);
  $("#application_note").on("keyup",enable_save_note);
});

</script>

{% endblock %}

{% block content %}

<div class="row">
  <div class="col-lg-2 col-md-2 no-space">
    <label>School</label>
    <select class="form-control" id="filter_school">
      <option value="1">UC Berkeley</option>
    </select>
  </div>
  <div class="col-lg-2 col-md-2 no-space">
    <label>Event</label>
    <select class="form-control" id="filter_event">
    </select>
  </div>
  <div class="col-lg-2 col-md-2 no-space">
    <label>Categories</label>
    <select class="form-control" id="filter_applicants">
      <option value="1">Applicants that are awaiting response</option>
      <option value="2">Applicants I've talked to</option>
      <option value="3">Applicants I've rejected</option>
      <option value="4">Applicants to interview</option>
      <option value="5">All event attendees</option>
    </select>
  </div>
  <div class="col-lg-2 col-md-2 no-space">
    <label>Majors</label>
    <select class="form-control" id="major_type">
      <option value=""></option>
      <option value="1">Accounting</option>
      <option value="2">Aerospace Engineering</option>
      <option value="3">Anthropology</option>
      <option value="4">Applied Mathematics</option>
      <option value="5">Architecture</option>
      <option value="6">Art</option>
      <option value="7">Art History</option>
      <option value="8">Artificial Intelligence</option>
      <option value="9">Biochemistry</option>
      <option value="10">Bioengineering</option>
      <option value="11">Biology</option>
      <option value="12">Business</option>
      <option value="13">Chemical Engineering</option>
      <option value="14">Chemistry</option>
      <option value="15">Chinese</option>
      <option value="16">Civil Engineering</option>
      <option value="17">Cognitive Science</option>
      <option value="18">Communications</option>
      <option value="19">Computer Engineering</option>
      <option value="20">Computer Science</option>
      <option value="21">Design</option>
      <option value="22">Economics</option>
      <option value="23">Education</option>
      <option value="24">Electrical Engineering</option>
      <option value="25">Embedded Systems</option>
      <option value="26">English</option>
      <option value="27">Entrepreneurship</option>
      <option value="28">Environmental Studies</option>
      <option value="29">Finance</option>
      <option value="30">Fine Arts</option>
      <option value="31">French</option>
      <option value="32">Government</option>
      <option value="33">Graphic Design</option>
      <option value="34">History</option>
      <option value="35">Human Computer Interaction</option>
      <option value="36">Industrial Engineering</option>
      <option value="37">Informatics</option>
      <option value="38">Information Security</option>
      <option value="39">Information Technology</option>
      <option value="40">International Relations</option>
      <option value="41">Japanese</option>
      <option value="42">Journalism</option>
      <option value="43">Law</option>
      <option value="44">Linguistics</option>
      <option value="45">Literature</option>
      <option value="46">Machine Learning</option>
      <option value="47">Marketing</option>
      <option value="48">Materials Science</option>
      <option value="49">Mathematics</option>
      <option value="50">Mechanical Engineering</option>
      <option value="51">Molecular Biology</option>
      <option value="52">Music</option>
      <option value="53">Nanotechnology</option>
      <option value="54">Neuroscience</option>
      <option value="55">Nuclear Engineering</option>
      <option value="56">Operations Research</option>
      <option value="57">Philosophy</option>
      <option value="58">Physics</option>
      <option value="59">Political Science</option>
      <option value="60">Project Management</option>
      <option value="61">Psychology</option>
      <option value="62">Robotics</option>
      <option value="63">Sociology</option>
      <option value="64">Software Engineering</option>
      <option value="65">Spanish</option>
      <option value="66">Statistics</option>
      <option value="67">Symbolic Systems</option>
      <option value="68">Systems Engineering</option>
      <option value="69">Telecommunications</option>
    </select>
  </div>
  <div class="col-lg-1 col-md-1 no-space">
    <label>Degree</label>
    <select class="form-control" id="degree_type">
      <option value=""></option>
      <option value="1">BA</option>
      <option value="2">BS</option>
      <option value="3">MS</option>
      <option value="4">MA</option>
      <option value="5">MBA</option>
      <option value="6">JS</option>
      <option value="7">PhD</option>
      <option value="8">High School Diploma</option>
    </select>
  </div>
  <div class="col-lg-1 col-md-1 no-space">
    <label>Grad Date</label>
    <select class="form-control" id="grad_year">
      <option value=""></option>
      <option value="2010">2010</option>
      <option value="2011">2011</option>
      <option value="2012">2012</option>
      <option value="2013">2013</option>
      <option value="2014">2014</option>
      <option value="2015">2015</option>
      <option value="2016">2016</option>
      <option value="2017">2017</option>
      <option value="2018">2018</option>
    </select>
  </div>
  <div class="col-lg-2 col-md-2 no-space">
    <form action="/recruiter/hire/download_excel_to_export/" method="post">
      <input type="hidden" name="fair_id" value="" id="fair_id_input">
      <input type="hidden" name="company_id" value="{{request.user.recruiter.company.id}}" id="company_id_input">
      {% csrf_token %}
      <input type="submit" value="Export Data" class="btn btn-inverted-default pull-right">
    </form>
  </div>
</div>

<br />

<div class="row">
  <div class="col-lg-3 col-md-3 category_box">
    <div class="row" id="category_header_box">
      <h4 id="category_header">List of Candidates</h4>
      <!-- <h5 id="category_subheader">Select a candidate.</h5> -->
      <hr style="margin-bottom:0px;">
      <input type="text" class="form-control" placeholder="Search by name" id="search_applicants" style="width:100%;border-radius:0px;">
    </div>
    <div class="row">
      <div class="list-group" id="candidate_list">
        <!-- Candidates will appear here -->
      </div>
    </div>
  </div>
  <div class="col-lg-9 col-md-9 category_box" id="application_info" style="display:none; text-align:center;">
    <div class="row" id="category_header_box">
        <h3 id="category_header"><span id="application_first_name">First</span>&nbsp;<span id="application_last_name">Last Name</span></h3>
        <h5 id="category_subheader"><span id="application_email">Email</span><h5>
        <h5 id="category_subheader"><span id="application_status">Application Status</span></h5>
        <button class="btn btn-lg btn-success" id="accept_applicant_btn" style="position:absolute; top:10px; right:10px;">To Interview</button>
        <button class="btn btn-lg btn-danger" id="reject_applicant_btn" style="position:absolute; top:10px; left:10px;">Reject</button>
        <hr>
    </div>
    <div class="row" id="note_div">
      <div class="col-lg-12">
        <h4>Notes</h4>
        <a class="btn btn-done btn-sm pull-right" disabled id="application_note_btn" style="margin-top:-34px;">Save Note</a>
        <textarea class="form-control" style="width:100%;" id="application_note">Sample Note</textarea>
      </div>
    </div>
    <br />
    <div class="row">
      <div class="col-lg-12">
        <h4>Resume</h4>
        <a class="btn btn-done btn-sm pull-right" id="download_pdf_btn" style="margin-top:-34px;">Download</a>
        <div style="text-align:center;">
          <img style="border:1px solid #acacac;" src="https://resumefeed.s3.amazonaws.com/sanchit-barejapdfu01nBM1mjF4kaWEJmaXcdgkyP4fBqI" id="application_resume_img">
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  
</script>

<!-- hard code everything for design -->
{% endblock %}